---
import PageLayout from '@/layouts/PageLayout.astro';
import { Icon } from 'astro-icon/components';

export async function getStaticPaths() {
    const allPosts = Object.values(import.meta.glob('../posts/*.md', { eager: true }));
    const uniqueTags = [...new Set(
        allPosts.map((post: any) => post.frontmatter.tags).flat()
    )];

    return uniqueTags.map((tag) => {
        const filteredPosts = allPosts
            .filter((post: any) => post.frontmatter.tags.includes(tag))
            .sort((a: any, b: any) => new Date(b.frontmatter.pubDate).getTime() - new Date(a.frontmatter.pubDate).getTime());
        return {
            params: { tag },
            props: { posts: filteredPosts },
        };
    });
}

const { tag } = Astro.params;
const { posts } = Astro.props;

---

<PageLayout pageTitle={tag}>
  <h1>#{tag}のタグが付いた記事</h1>
  <ul>
    {
      posts.map((post: any) => {
        const category = post.frontmatter.tags.includes("tech") ? "tech" : "life";
        return (
          <li class={`post-item post-${category}`}>
            <a href={post.url}>
              <Icon name={category === "tech" ? "mdi:code-tags" : "mdi:heart"} class="category-icon" />
              <span class="post-title">{post.frontmatter.title}</span>
              <span class="post-date">{post.frontmatter.pubDate.toString().slice(0,10)}</span>
            </a>
          </li>
        );
      })
    }
  </ul>
</PageLayout>

<style>
  .post-item a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .category-icon {
    font-size: 1.2rem;
    flex-shrink: 0;
    color: var(--color-text);
    transition: color 0.2s ease;
  }

  .post-title {
    flex: 1;
  }

  .post-date {
    font-size: 0.9rem;
    opacity: 0.7;
    flex-shrink: 0;
  }
</style>